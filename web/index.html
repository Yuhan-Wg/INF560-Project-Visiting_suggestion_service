<html>

<head>

<link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="./buttons.css" rel="stylesheet" media="screen">
<link href="./date-picker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>

<script type="text/javascript" src="./jquery/jquery-1.8.3.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="./date-picker/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
<!--
<script type="text/javascript" src="./date-picker/js/locales/bootstrap-datetimepicker.us.js" charset="UTF-8"></script>
-->

<!--
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
-->

<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="heatmap.js/build/heatmap.js"></script>

<style>
        #heatmap  {
            width:600px; height:400px;border: 1px solid;border-color: grey;
        }
    </style>
</head>

<body>
<!-- Add a date time & picker using Bootstrap -->
  <div class="container">
    <form action="" class="form-horizontal"  role="form">
        <fieldset>

            <legend>Choose Date and Time</legend>
<!--
            <div class="form-group">
                <label for="dtp_input1" class="col-md-2 control-label">DateTime Picking</label>
                <div class="input-group date form_datetime col-md-5" data-date="1979-09-16T05:25:07Z" data-date-format="dd MM yyyy - HH:ii p" data-link-field="dtp_input1">
                    <input class="form-control" size="16" type="text" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
					<span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                </div>
				<input type="hidden" id="dtp_input1" value="" /><br/>
            </div>
-->

			<div class="form-group">
                <label for="dtp_input2" class="col-md-2 control-label">Date Picking</label>
                <div class="input-group date form_date col-md-5" data-date="" data-date-format="dd MM yyyy" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                    <input class="form-control" size="16" type="text" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
					<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>
				<input type="hidden" id="dtp_input2" value="" /><br/>
            </div>
			<div class="form-group">
                <label for="dtp_input3" class="col-md-2 control-label">Time Picking</label>
                <div class="input-group date form_time col-md-5" data-date="" data-date-format="hh:ii" data-link-field="dtp_input3" data-link-format="hh:ii">
                    <input class="form-control" size="16" type="text" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
					<span class="input-group-addon"><span class="glyphicon glyphicon-time"></span></span>
                </div>
				<input type="hidden" id="dtp_input3" value="" /><br/>
            </div>
            <button onclick="fun()" class="button button-action button-pill" id = "reset"  type="button">Apply</button>
        </fieldset>
    </form>
</div>


    <svg id = "heat" version="1.1"    width="1500" height="800" viewBox="-100 180 1800 800"


        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">

       <image xlink:href="floor b1.png" width="1500" height="800"/>


    </svg>

<div id="heatmap"></div>

<script type="text/javascript">
function skyscale(x, y,minX,maxX,minY,maxY) {
    if(y>39){console.log("!!!!!!!!")}
    var scalex = d3.scaleLinear();
		scalex.domain([0,50])
		     .range([190,1390]);
    var newx = scalex(x);

    var scaley = d3.scaleLinear();
		scaley.domain([0,43])
		     .range([200,590]);
    var newy = scaley(y);
    //console.log(x, y,minX,maxX,minY,maxY)
    return [newx, newy];
}
function fun(){
d3.selectAll("g").remove()
var x = document.getElementById("dtp_input2").value
var y = document.getElementById("dtp_input3").value
console.log(x)
var month = x.split("-")[1]
if(month[0] == "0")
{
    month = month[1]
}
var day = x.split("-")[2]
var hour = y.split(":")[0]
var minute = 0
if( y.split(":")[1] == "00" || y.split(":")[1] == "05"|| y.split(":")[1] == "10")
{
    minute = 0
}
else if( y.split(":")[1] == "15" || y.split(":")[1] == "20"|| y.split(":")[1] == "25")
{
    minute = 1
}
else if( y.split(":")[1] == "30" || y.split(":")[1] == "35"|| y.split(":")[1] == "40")
{
    minute = 2
}
else if( y.split(":")[1] == "45" || y.split(":")[1] == "50"|| y.split(":")[1] == "55")
{
    minute = 3
}
var file = x+".csv"
console.log(file)
console.log(month)
console.log(day)
console.log(hour)
console.log(minute)
d3.csv("data.csv"
, function (d) {  //d contains datum of current row
    //console.log(d)
    if(d.Level == 0 && d.month==month
    && d.day == day && d.hour == hour && d.quarter==minute)
    {
        console.log(d)
        return  d ;
    }
}).then(function(blockdata){
var minCount= d3.min(blockdata, function (d) { return parseInt(d.count); });
var maxCount = d3.max(blockdata, function (d) { return parseInt(d.count); });
var minX= d3.min(blockdata, function (d) { return parseInt(d.latBlock); });
var maxX= d3.max(blockdata, function (d) { return parseInt(d.latBlock); });
var minY= d3.min(blockdata, function (d) { return parseInt(d.lngBlock); });
var maxY= d3.max(blockdata, function (d) { return parseInt(d.lngBlock); });
console.log(minCount,maxCount,minX,maxX,minY,maxY)
// Function skyscale() scales the coordinate of the blocks to fit the background floorplan image
// Use scaleLinear to produce different color code
var res = d3.scaleLinear()
  .domain([-20,120])
  .range(['#EFECEC','#CE0000']);
var svg = d3.select("#heat")
    //console.log(blockdata)

// Draw the blocks on the floorplan
    svg.append("g")
        .attr("class","blocks")
        .selectAll("rect")
        .data(blockdata)
        .enter()
        .append("rect")
        .attr("width","24")
        .attr("height","7")
        .attr("x",function(d)
        {   //console.log(d)
            //console.log(d.latBlock)
           // console.log(laProjection(d.geometry.coordinates))
            //return 190+1390-skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[0];
            return skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[0];
        })
        .attr("y",function(d)
        {
           // console.log(laProjection(d.geometry.coordinates))
           //return (skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[1]);
           return (200+590-skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[1]);
        })
        .attr("fill",function(d)
        {
           // console.log(laProjection(d.geometry.coordinates))
           return res(d.count);
        })
})
}
var svg = d3.select("#heat"),
  width = +svg.attr("width"),
  height = +svg.attr("height");
/*
function skyscale(x, y) {
    if(y>50){console.log("!!!!!!!!")}
    var scalex = d3.scaleLinear();
		scalex.domain([0,50])
		     .range([190,1390]);
    var newx = scalex(x);

    var scaley = d3.scaleLinear();
		scaley.domain([0,50])
		     .range([200,590]);
    var newy = scaley(y);
    //console.log(x)
    return [newx, newy];
}
*/
/*
function color(count){
    //console.log(count)
    var res = d3.scaleLinear()
  .domain([d3.min(blockdata.count), d3.max(blockdata.count)])
  .range(['rgb(255, 245, 235)', 'rgb(127, 39, 4)']);
    console.log(res(count))
    return res(count);
}
*/
  /*
  svg.append("rect")
        .attr("width","10")
        .attr("height","10")
        .attr("x","1390")
        .attr("y","590")
        .attr("fill","red")
    */
// Load data from data.csv to d3, implementing data join to draw the heatmap
d3.csv("data.csv"
, function (d) {  //d contains datum of current row
    if(d.Level == 0 && d.month==4
    && d.day == 25 &&d.hour == 11 && d.quarter==0)
    {
        return  d ;
    }
}).then(function(blockdata){
var minCount= d3.min(blockdata, function (d) { return parseInt(d.count); });
var maxCount = d3.max(blockdata, function (d) { return parseInt(d.count); });
var minX= d3.min(blockdata, function (d) { return parseInt(d.latBlock); });
var maxX= d3.max(blockdata, function (d) { return parseInt(d.latBlock); });
var minY= d3.min(blockdata, function (d) { return parseInt(d.lngBlock); });
var maxY= d3.max(blockdata, function (d) { return parseInt(d.lngBlock); });
console.log(minCount,maxCount,minX,maxX,minY,maxY)
// Function skyscale() scales the coordinate of the blocks to fit the background floorplan image
// Use scaleLinear to produce different color code
var res = d3.scaleLinear()
  .domain([minCount,120])
  .range(['#EFECEC','#CE0000']);
    //console.log(blockdata)

// Draw the blocks on the floorplan
    svg.append("g")
        .attr("class","blocks")
        .selectAll("rect")
        .data(blockdata)
        .enter()
        .append("rect")
        .attr("width","24")
        .attr("height","7")
        .attr("x",function(d)
        {   //console.log(d)
            //console.log(d.latBlock)
           // console.log(laProjection(d.geometry.coordinates))
            //return 190+1390-skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[0];
            return skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[0];
        })
        .attr("y",function(d)
        {
           // console.log(laProjection(d.geometry.coordinates))
           //return (skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[1]);
           return (200+590-skyscale(d.lngBlock,d.latBlock,minX,maxX,minY,maxY)[1]);
        })
        .attr("fill",function(d)
        {
           // console.log(laProjection(d.geometry.coordinates))
           return res(d.count);
        })
})



// Here is the logic of time-picker
$('.form_datetime').datetimepicker({
        //language:  'fr',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		forceParse: 0,
        showMeridian: 1
    });
	$('.form_date').datetimepicker({
        language:  'us',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
	$('.form_time').datetimepicker({
        language:  'us',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 1,
		minView: 0,
		maxView: 1,
		forceParse: 0
    });
var heatmapInstance = h337.create({
    container: document.querySelector('#heatmap'),
});
var points = [];
var max = 0;
var width = 600;
var height = 400;
var len = 200;
while (len--) {
    var val = Math.floor(Math.random()*100);
    max = Math.max(max, val);
    var point = {
        x: Math.floor(Math.random()*width),
        y: Math.floor(Math.random()*height),
        value: val
    };
    points.push(point);
}
var data2 = {
    max: max,
    data: points
};
heatmapInstance.setData(data2); //数据绑定还可以使用
</script>

</body>


</html>
